<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¹¿å‘Šæ‹¦æˆªæ£€æµ‹å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .test-area {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            display: none;
        }
        #adsenseTest { background: #ffebee; }
        #adContainerTest { background: #e8f5e9; }
        .detected { border: 2px solid #c62828; }
        .clean { border: 2px solid #2e7d32; }
        button {
            padding: 12px 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .result {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .test-result {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 1rem 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .test-info p {
            margin: 0.25rem 0;
            color: #666;
        }
        .summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #e8f5e9; /* é»˜è®¤èƒŒæ™¯è‰² */
            border-radius: 8px;
        }
        .details {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .details span {
            display: block;
            color: #666;
            margin-bottom: 0.3rem;
        }
        .warning {
            color: #c62828;
            margin: 0.3rem 0;
            padding-left: 1.2rem;
            position: relative;
        }
        .warning::before {
            content: "!";
            position: absolute;
            left: 0;
            top: 0;
            width: 1em;
            height: 1em;
            background: #c62828;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 1em;
            font-size: 0.8em;
        }
        .progress-bar {
            width: 80%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            margin: 1rem auto;
            overflow: hidden;
        }
        .progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #64b5f6);
            transition: width 0.5s ease-in-out;
        }
        .status-text {
            text-align: center;
            margin-top: 1rem;
            color: #666;
            min-height: 1.5em;
            transition: opacity 0.3s ease-in;
        }
        .explain {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }
        .explain p {
            line-height: 1.6;
            color: #444;
        }
        .impact {
            margin-top: 0.8rem;
            padding: 0.8rem;
            background: #fff3e0;
            border-left: 3px solid #ffa726;
            border-radius: 4px;
        }
        .impact span {
            font-weight: 500;
            color: #ef6c00;
        }
        .status-hint {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 2rem;
        }
        .icon-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .icon-hint .status-icon {
            font-size: 1.2em;
        }
        .status-icon.âœ… { color: #4CAF50; }
        .status-icon.âš ï¸ { color: #FF5722; }
        .error-message {
            color: #757575;
            font-size: 0.9em;
            margin-top: 0.5rem;
            padding: 0.8rem;
            background: #f5f5f5;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>å¹¿å‘Šæ‹¦æˆªæ£€æµ‹å™¨</h1>
    <button onclick="runDetection()">å¼€å§‹æ£€æµ‹</button>
    <div id="result" class="result"></div>

    <!-- å¹¿å‘Šæµ‹è¯•å…ƒç´  -->
    <div class="test-area" id="adsenseTest">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1234567890"
        crossorigin="anonymous"></script>
    </div>
    
    <div class="test-area" id="adContainerTest">
        <div class="ad-banner" style="width: 1px; height: 1px; position: absolute; left: -9999px;"></div>
    </div>

    <div class="status-hint">
        <div class="icon-hint">
            <span class="status-icon">âœ…</span>
            <p>æ­£å¸¸ - æœªå‘ç°æ‹¦æˆªè¡Œä¸º</p>
        </div>
        <div class="icon-hint">
            <span class="status-icon">â›”</span>
            <p>æ‹¦æˆª - æ£€æµ‹åˆ°å¹¿å‘Šå±è”½</p>
        </div>
    </div>

    <script>
        // ç»Ÿä¸€æ£€æµ‹ç»“æœæ ¼å¼
        const DetectionResult = {
            BLOCKED: { status: true, code: 'BLOCKED' },
            ALLOWED: { status: false, code: 'ALLOWED' },
            ERROR: { status: false, code: 'ERROR' }
        };

        // æ·»åŠ è°ƒè¯•æ¨¡å¼
        const DEBUG_MODE = true;

        function debugLog(...args) {
            if (DEBUG_MODE) {
                console.log('[DEBUG]', ...args);
            }
        }

        async function runDetection() {
            debugLog('å¼€å§‹æ£€æµ‹æµç¨‹');
            try {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div class="progress-bar">
                            <div class="progress"></div>
                        </div>
                        <p class="status-text">åˆå§‹åŒ–æ£€æµ‹ç¯å¢ƒ...</p>
                    </div>
                `;

                const steps = [
                    { text: 'åˆå§‹åŒ–æ£€æµ‹ç¯å¢ƒ...', action: initializeDetection },
                    { text: 'æ­£åœ¨æ£€æµ‹å¹¿å‘Šè„šæœ¬...', action: checkAdScripts },
                    { text: 'æ‰«æè·Ÿè¸ªè„šæœ¬...', action: checkTrackers },
                    { text: 'éªŒè¯å¹¿å‘Šå®¹å™¨...', action: checkContainers },
                    { text: 'æ£€æµ‹å¼¹çª—æ‹¦æˆª...', action: checkPopups },
                    { text: 'åˆ†æè§†é¢‘å¹¿å‘Š...', action: checkVideoAds },
                    { text: 'æœ€ç»ˆç»“æœæ±‡æ€»...', action: finalizeDetection }
                ];

                const testResults = {};
                const testItems = [
                    { name: 'Google Adsense', desc: 'ä¸»æµå¹¿å‘Šæ‹¦æˆªå·¥å…·é€šå¸¸ä¼šå±è”½çš„å¹¿å‘ŠæœåŠ¡' },
                    { name: 'å¹¿å‘Šå®¹å™¨', desc: 'æ£€æµ‹å¸¸è§å¹¿å‘Šå®¹å™¨çš„CSSéšè—æ–¹å¼' },
                    { name: 'è·Ÿè¸ªè„šæœ¬', desc: 'éšç§ä¿æŠ¤å·¥å…·å¸¸å±è”½çš„è·Ÿè¸ªè„šæœ¬' },
                    { name: 'ç¤¾äº¤åª’ä½“æ’ä»¶', desc: 'ç¤¾äº¤åª’ä½“æŒ‰é’®å’Œåˆ†äº«ç»„ä»¶çš„æ‹¦æˆªæƒ…å†µ' },
                    { name: 'DoubleClickå¹¿å‘Š', desc: 'Googleçš„å±•ç¤ºå¹¿å‘ŠæœåŠ¡æ£€æµ‹' },
                    { name: 'å¼¹çª—å¹¿å‘Š', desc: 'æµè§ˆå™¨å¼¹çª—æ‹¦æˆªåŠŸèƒ½æ£€æµ‹' },
                    { name: 'è§†é¢‘å¹¿å‘Š', desc: 'è§†é¢‘å‰è´´ç‰‡å¹¿å‘Šæ‹¦æˆªæ£€æµ‹' }
                ];

                debugLog('æ€»æ£€æµ‹æ­¥éª¤:', steps.length);
                for (let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    debugLog('å¼€å§‹æ‰§è¡Œæ­¥éª¤:', step.text);
                    try {
                        testResults[step.action.name] = await step.action();
                        debugLog('æ­¥éª¤å®Œæˆ:', step.text, 'ç»“æœ:', testResults[step.action.name]);
                    } catch (e) {
                        console.error('æ­¥éª¤æ‰§è¡Œå¤±è´¥:', step.text, e);
                        testResults[step.action.name] = false;
                    }
                    updateProgress((i + 1) * (100 / steps.length), step.text);
                }

                // å°†ç»“æœæ˜ å°„åˆ°æµ‹è¯•é¡¹
                const finalResults = testItems.map(item => ({
                    ...item,
                    status: getTestStatus(item.name, testResults)
                }));

                showResults(finalResults);
            } catch (e) {
                console.error('æ£€æµ‹æµç¨‹å¼‚å¸¸:', e);
            }
        }

        let lastUpdate = 0;
        function updateProgress(percent, text) {
            if (typeof percent !== 'number' || percent < 0) {
                console.warn('æ— æ•ˆçš„è¿›åº¦å€¼:', percent);
                percent = 0;
            }
            const now = Date.now();
            if (now - lastUpdate < 50) return; // é™åˆ¶æ›´æ–°é¢‘ç‡
            
            lastUpdate = now;
            requestAnimationFrame(() => {
                const progressBar = document.querySelector('.progress');
                const statusText = document.querySelector('.status-text');
                
                progressBar.style.width = `${Math.min(percent, 100)}%`;
                statusText.textContent = text;
                statusText.style.opacity = 1;
            });
        }

        async function initializeDetection() {
            debugLog('å¼€å§‹åˆå§‹åŒ–æ£€æµ‹ç¯å¢ƒ');
            const testElements = [
                { selector: '#adsenseTest', timeout: 1500 },
                { selector: '#adContainerTest', timeout: 1000 }
            ];

            for (const element of testElements) {
                debugLog('æ£€æŸ¥æµ‹è¯•å…ƒç´ :', element.selector);
                const start = Date.now();
                let found = false;
                
                while (Date.now() - start < element.timeout) {
                    const el = document.querySelector(element.selector);
                    debugLog('å…ƒç´ çŠ¶æ€:', {
                        selector: element.selector,
                        exists: !!el,
                        visible: el?.offsetHeight > 0
                    });
                    
                    if (el?.offsetHeight > 0) {
                        found = true;
                        break;
                    }
                    await new Promise(r => setTimeout(r, 50));
                }
                
                debugLog(found ? 'å…ƒç´ æ£€æµ‹æˆåŠŸ' : 'å…ƒç´ æ£€æµ‹è¶…æ—¶', element.selector);
            }
            debugLog('åˆå§‹åŒ–å®Œæˆ');
        }

        async function checkAdScripts() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(isAdsenseBlocked() || isDoubleClickBlocked());
                }, 500);
            });
        }

        async function checkTrackers() {
            try {
                return await new Promise(resolve => {
                    const testScript = document.createElement('script');
                    testScript.onload = () => resolve(false);
                    testScript.onerror = () => resolve(true);
                    testScript.src = 'https://www.google-analytics.com/analytics.js';
                    document.head.appendChild(testScript);
                    
                    setTimeout(() => {
                        document.head.removeChild(testScript);
                        resolve(true);
                    }, 1500);
                });
            } catch (e) {
                console.error('Trackeræ£€æµ‹å¼‚å¸¸:', e);
                return true;
            }
        }

        function isAdsenseBlocked() {
            debugLog('å¼€å§‹æ£€æµ‹AdSense');
            return new Promise(resolve => {
                const script = document.createElement('script');
                let timedOut = false;
                
                const cleanup = () => {
                    document.head.removeChild(script);
                    clearTimeout(timeout);
                };

                script.onload = () => {
                    debugLog('AdSenseè„šæœ¬åŠ è½½æˆåŠŸ');
                    if (!timedOut) {
                        cleanup();
                        resolve(false);
                    }
                };

                script.onerror = () => {
                    debugLog('AdSenseè„šæœ¬åŠ è½½å¤±è´¥');
                    if (!timedOut) {
                        cleanup();
                        resolve(true);
                    }
                };

                script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?rand=' + Math.random();
                document.head.appendChild(script);

                const timeout = setTimeout(() => {
                    timedOut = true;
                    cleanup();
                    resolve(true);
                }, 2000);
            });
        }

        function isAdContainerHidden() {
            // æ£€æŸ¥å¹¿å‘Šå®¹å™¨å…ƒç´ æ˜¯å¦è¢«éšè—
            const ad = document.querySelector('.ad-banner');
            return ad.offsetParent === null || 
                   window.getComputedStyle(ad).display === 'none' ||
                   ad.offsetHeight === 0;
        }

        function isTrackerBlocked() {
            try {
                const testScript = document.createElement('script');
                testScript.src = 'https://www.google-analytics.com/analytics.js';
                return testScript.src.includes('undefined');
            } catch (e) {
                return true;
            }
        }

        function isSocialWidgetBlocked() {
            const testDiv = document.createElement('div');
            testDiv.className = 'fb-like';
            document.body.appendChild(testDiv);
            const isHidden = window.getComputedStyle(testDiv).display === 'none';
            document.body.removeChild(testDiv);
            return isHidden;
        }

        function isDoubleClickBlocked() {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(false);
                img.onerror = () => resolve(true);
                img.src = 'https://ad.doubleclick.net/favicon.ico?' + Date.now();
                
                // æ·»åŠ è¶…æ—¶å¤„ç†
                setTimeout(() => resolve(true), 1000);
            });
        }

        async function checkPopups() {
            try {
                const result = await isPopupBlocked();
                return result ? DetectionResult.BLOCKED : DetectionResult.ALLOWED;
            } catch (e) {
                return DetectionResult.ERROR;
            }
        }

        function isVideoAdBlocked() {
            const testVideo = document.createElement('video');
            try {
                testVideo.className = 'video-ads';
                document.body.appendChild(testVideo);
                const isHidden = window.getComputedStyle(testVideo).display === 'none';
                return isHidden;
            } finally {
                testVideo.remove();
            }
        }

        async function checkContainers() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(isAdContainerHidden());
                }, 300);
            });
        }

        async function checkVideoAds() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(isVideoAdBlocked());
                }, 400);
            });
        }

        async function finalizeDetection() {
            debugLog('æ¸…ç†æµ‹è¯•ç¯å¢ƒ');
            try {
                document.querySelectorAll('.test-area').forEach(el => {
                    el.style.display = 'none';
                    el.style.visibility = 'hidden';
                });
                return true;
            } catch (e) {
                console.error('æ¸…ç†å¤±è´¥:', e);
                return false;
            }
        }

        function showResults(tests) {
            const resultDiv = document.getElementById('result');
            let resultHTML = '<h3>ğŸ·ï¸ æ£€æµ‹æŠ¥å‘Š</h3>';
            
            tests.forEach(test => {
                resultHTML += `
                    <div class="test-result">
                        <span class="status-icon">${test.status ? 'âœ…' : 'âš ï¸'}</span>
                        <div class="test-info">
                            <h4>${test.name}</h4>
                            <div class="details">
                                <p>${test.status ? 'âœ… å·²å®‰å…¨æ‹¦æˆª' : 'âš ï¸ æœªå—ä¿æŠ¤'}</p>
                                <div class="explain">
                                    <p>${getHumanReadableDesc(test.name, test.status)}</p>
                                    ${test.status ? `
                                    <div class="impact">
                                        <span>ğŸ“Œ å¯èƒ½å½±å“ï¼š</span>
                                        ${getImpactDesc(test.name)}
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            const blockedCount = tests.filter(t => t.status).length;
            
            resultHTML += `
                <div class="summary">
                    <h3>å®‰å…¨çŠ¶æ€ï¼š${blockedCount}/${tests.length}</h3>
                    <p>${blockedCount > 0 ? 
                        'âœ… å®‰å…¨ - å·²å¯ç”¨å¹¿å‘Šæ‹¦æˆª' : 
                        'âš ï¸ æ³¨æ„ - æœªæ£€æµ‹åˆ°æœ‰æ•ˆé˜²æŠ¤'}</p>
                </div>
            `;

            const blockedRequests = tests.filter(t => t.status).length;
            
            resultHTML += `
                <div class="explain">
                    <p>ğŸ” æ³¨æ„ï¼šæ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°çš„èµ„æºæ‹¦æˆªæç¤ºè¡¨ç¤ºå¹¿å‘Šæ‹¦æˆªå·¥å…·æ­£åœ¨æ­£å¸¸å·¥ä½œ</p>
                    <p>âš ï¸ å…±æ‹¦æˆªäº†${blockedRequests}ä¸ªå¹¿å‘Šç›¸å…³è¯·æ±‚</p>
                </div>
            `;

            resultDiv.innerHTML = resultHTML;
            
            // åœ¨å…ƒç´ åˆ›å»ºåè®¾ç½®æ ·å¼
            const summary = resultDiv.querySelector('.summary');
            if (summary) {
                summary.style.backgroundColor = blockedCount > 0 ? '#fff3e0' : '#e8f5e9';
            }
        }

        function getHumanReadableDesc(name, status) {
            const descriptions = {
                'Google Adsense': status ? 
                    'ç³»ç»Ÿå‘ç°æ‚¨çš„æµè§ˆå™¨é˜»æ­¢äº†Googleå¹¿å‘Šè„šæœ¬çš„åŠ è½½ï¼Œè¿™é€šå¸¸ç”±å¹¿å‘Šæ‹¦æˆªæ‰©å±•å¼•èµ·' : 
                    'Googleå¹¿å‘ŠæœåŠ¡åŠ è½½æ­£å¸¸ï¼Œæœªæ£€æµ‹åˆ°æ‹¦æˆªè¡Œä¸º',
                'å¼¹çª—å¹¿å‘Š': status ?
                    'æµè§ˆå™¨æˆåŠŸæ‹¦æˆªäº†æµ‹è¯•å¼¹çª—ï¼Œè¿™å¯èƒ½æ¥è‡ªæµè§ˆå™¨å†…ç½®çš„å¼¹å‡ºçª—å£æ‹¦æˆªåŠŸèƒ½' :
                    'æœªå¯ç”¨å¼¹çª—æ‹¦æˆªåŠŸèƒ½ï¼Œç½‘ç«™å¼¹çª—å¯ä»¥æ­£å¸¸æ˜¾ç¤º',
                'è§†é¢‘å¹¿å‘Š': status ?
                    'æ£€æµ‹åˆ°è§†é¢‘å‰è´´ç‰‡å¹¿å‘Šè¢«è·³è¿‡æˆ–å±è”½' :
                    'è§†é¢‘å¹¿å‘Šæ’­æ”¾åŠŸèƒ½æ­£å¸¸'
            };
            return descriptions[name] || (status ? 'æ£€æµ‹åˆ°æ‹¦æˆªè¡Œä¸º' : 'æœªå‘ç°å¼‚å¸¸');
        }

        function getImpactDesc(name) {
            const impacts = {
                'Google Adsense': 'ç½‘ç«™å¹¿å‘Šæ”¶ç›Šå¯èƒ½å—åˆ°å½±å“',
                'è·Ÿè¸ªè„šæœ¬': 'ç”¨æˆ·è¡Œä¸ºåˆ†ææ•°æ®å¯èƒ½ä¸å®Œæ•´',
                'è§†é¢‘å¹¿å‘Š': 'è§†é¢‘å†…å®¹æä¾›å•†å¯èƒ½é™åˆ¶æ’­æ”¾'
            };
            return impacts[name] || 'å¯èƒ½å½±å“éƒ¨åˆ†ç½‘ç«™åŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨';
        }

        function getConfidenceLevel(name) {
            const levels = {
                'Google Adsense': 'é«˜',
                'å¼¹çª—å¹¿å‘Š': 'ä¸­',
                'è§†é¢‘å¹¿å‘Š': 'ä¸­'
            };
            return levels[name] || 'ä¸­';
        }

        function getTestStatus(name, results) {
            const statusMap = {
                'Google Adsense': results.checkAdScripts,
                'å¹¿å‘Šå®¹å™¨': results.checkContainers,
                'è·Ÿè¸ªè„šæœ¬': results.checkTrackers,
                'ç¤¾äº¤åª’ä½“æ’ä»¶': results.checkAdScripts, // æ ¹æ®å®é™…æ£€æµ‹è°ƒæ•´
                'DoubleClickå¹¿å‘Š': results.checkAdScripts,
                'å¼¹çª—å¹¿å‘Š': results.checkPopups,
                'è§†é¢‘å¹¿å‘Š': results.checkVideoAds
            };
            return !!statusMap[name];
        }
    </script>
</body>
</html> 